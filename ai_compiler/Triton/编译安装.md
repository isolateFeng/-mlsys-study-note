# Triton编译安装

## 配置python环境

建议使用conda配置，选择python3.10会稳定些

`conda create -n triton_env python=3.10` 

- 根据cuda版本安装pytorch(gpu版)

例如我用的是cuda11.8，那么

```bash
conda install pytorch==2.2.1 torchvision==0.17.1 torchaudio==2.2.1 pytorch-cuda=11.8 -c pytorch -c nvidia
```

详细见官网：https://pytorch.org/get-started/previous-versions/

- 安装常见的包

numpy, matplotlib, pybind11 ...

pybind11安装后需要配置环境变量，否则会找不到头文件

```bash
export PYBIND_INCLUDE_PATH=/xxxx/miniconda/envs/triton_env/lib/python3.10/site-packages/pybind11/include
```

下面的源挺好用的 `vim ~/.condarc`

```bash
show_channel_urls: true
channels:
  - http://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/
  - http://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
  - http://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
  - defaults
auto_activate_base: false
```

## 编译llvm

```bash
git clone https://github.com/openai/triton.git
git clone https://github.com/llvm/llvm-project
```

如果拉取出现下面报错，在repo内输入 `git config --global http.postBuffer 1024288000`

```bash
remote: Compressing objects: 100% (1151/1151), done.
error: RPC failed; result=18, HTTP code = 200| 592.00 KiB/s    
fatal: The remote end hung up unexpectedly
fatal: 过早的文件结束符（EOF）
fatal: index-pack failed
```

- 切换llvm commit

git checkout xxx，其中xxx是triton对应的llvm版本号，可以使用 `cat triton/ccmake/llvm-hash.txt` 找到

- build

cmake 版本要求3.20以上，记得安装ninja。如果没有root权限就下编译好的二进制，解压后加PATH即可。

```bash
cd pathxxx/llvm-project
mkdir build && cd build
cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=ON  ../llvm -DLLVM_ENABLE_PROJECTS="mlir;llvm"
ninja -j32
```

## 编译triton

记得一直 `conda actiave triron_env`


fixme: third_party中一直某个pass的inc没有被td编译出来，导致编译失败

配置

```bash
cd pathxxx/triton

vim CMakeLists.txt

# 修改CMakelists.txt
# 开启TRITON_BUILD_PYTHON_MODULE
-option(TRITON_BUILD_PYTHON_MODULE "Build Python Triton bindings" OFF)
+option(TRITON_BUILD_PYTHON_MODULE "Build Python Triton bindings" ON)

# 添加MLIR_DIR（不然老是找不到），放在 `find_package(MLIR REQUIRED CONFIG PATHS ${MLIR_DIR})` 前面就行  
set(MLIR_DIR "xxxpath/llvm-project/build/lib/cmake/mlir")
```

```bash
mkdir build && cd build
cmake ..
make -j32
```

最终会在build目录下生成一个 `libtriton.so` 文件，将其加入到python环境中即可使用。


```bash
export LLVM_BUILD_DIR=pathxxx/llvm-project/build

cd pathxxx/triton
LLVM_INCLUDE_DIRS=$LLVM_BUILD_DIR/include \
LLVM_LIBRARY_DIR=$LLVM_BUILD_DIR/lib \
LLVM_SYSPATH=$LLVM_BUILD_DIR \
pip install -e python

```
